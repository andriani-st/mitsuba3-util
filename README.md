# mitsuba3-util

The purpose of mitsuba3-util is to simplify the use of mitsuba3 for rendering images and extend its output options. 

The util integrates mitsuba3 and provides a number of options to create rendered images or animations of objects. Also, some more specilised applications were created as described in the README files in stained_glass, filigree and cylinder_orderings folders. 

## Project structure

```
├── camera.py
├── canning
│   ├── curves_files: example of curves produced by running runme.m 
│   ├── runme.m: main MATLAB script for producing curves
│   └── Rz.m: helper MATLAB function
├── collection
│   ├── glass_collection: contains results of rendering simple .obj files as glass
├── config.json: example configuration file
├── cylinder_orderings
│   ├── curves_files: example of curves produced by generate_control_points.py
│   ├── generate_control_points.py: generates cylinder orderings by producing a txt file with curves
│   └── README.md
├── envmaps: enviroment maps from https://hdri-haven.com/ that can be used in the util
├── examples: rendered images and their corresponding configurations files that were used to generate them
├── filigree
│   ├── filigree_room.py: python script that places the filigree in a room
│   ├── image_surface.obj: example obj file generated by runme_with_colors_ref.m
│   ├── pattern.jpg: example binary image
│   ├── README.md
│   └── runme_with_colors_ref.m: main MATLAB script for generating a filigree obj from a binary image
├── object.py
├── obj_files: simple .obj files for testing
├── output.py
├── README.md
├── scene.py
├── stained_glass
│   ├── colors.txt: example colors file generated by runme.m
│   ├── flower.png
│   ├── getFrameInfo.m
│   ├── IsInImage.m
│   ├── README.md
│   ├── runme.m: main MATLAB script that creates the tiles of the stained glass, the colors of each tile and its skeleton from an image
│   ├── scaleTile.m
│   ├── skeleton.obj: example skeleton obj generated by runme.m
│   ├── stained_glass_room.py
│   ├── tiles: example obj files for tiles generated by runme.m
│   └── voronoizone.m
├── structure.txt
└── util.py: the main Python script
```

## Prerequisites
- Python 3.8.0

- mitsuba3 (https://mitsuba.readthedocs.io/en/latest/)
```
pip install mitsuba
```

- OpenCV (https://pypi.org/project/opencv-python/)
```
pip install opencv-python
```
- MATLAB

## Running the util

To run the util

```
python3 util.py /path/to/json/file/config.json
```

> Renders image/video using config.json

or

```
python3 util.py /path/to/folder/containing/multiple/json/files/
```

> Renders images/videos using all json files in /path/to/folder/containing/multiple/json/files/ folder

## Creating the configuration file
The general json schema of the configuration file is the following:
```
{
    "type": "object",
    "title": "Root Schema",
    "required": [
        "output",
        "objects",
        "lights"
    ],
    "properties": {
        "use_gpu": {
            "type": "boolean",
            "default": true
        },
        "output": {
            "type": "object"
        },
        "objects": {
            "type": "array",
            "items": {
                "type": "object"
            }
        },
        "lights": {
            "type": "array",
            "items": {
                "type": "object"
            }
        }
    }
}
```
As shown above the field `use_gpu` is optional, with a default value "true" when not provided, and the `output`, `objects`, `lights` fields are required. In the three subsections that follow the schema of each of the required json arrays is presented in detail.

> Note tha in case a field that is not needed is provided, it will simpy be ignored. 

> e.g. if `rotation_step` field is provided when output's `type` is image.

### "output" field: Camera and output settings
The schema of the `output` field is the following:
```
"output": {
    "type": "object",
    "title": "The output Schema",
    "properties": {
        "type": {
            "type": "string",
            "default": "",
            "examples": [
                "image",
                "animation_video",
                "rotation_video"
            ]
        },
        "results_folder": {
            "type": "string",
            "default": "",
            "examples": [
                "",
                "path/to/folder/"
            ]
        },
        "rotation_degrees": {
            "type": "integer",
            "default": 0,
            "examples": [
                0,
                360
            ]
        },
        "rotation_step": {
            "type": "integer",
            "default": 0,
            "examples": [
                1,
                10
            ]
        },
        "width": {
            "type": "integer",
            "default": 512,
            "examples": [
                512,
                1024
            ]
        },
        "height": {
            "type": "integer",
            "default": 512,
            "examples": [
                512,
                1080
            ]
        },
        "fps": {
            "type": "integer",
            "default": 5,
            "examples": [
                5,
                25
            ]
        },
        "target": {
            "type": "string",
            "default": "auto",
            "examples": [
                "auto",
                [0, 0, 0]
            ]
        },
        "distance": {
            "type": "number",
            "default": "auto",
            "examples": [
                "auto",
                100.5
            ]
        },
        "distance_from_target_sign": {
            "type": "string",
            "default": "+",
            "examples": [
                "+",
                "-"
            ]
        },
        "seed": {
            "type": "integer",
            "default": 0,
            "examples": [
                0,
                17
            ]
        },
        "fov": {
            "type": "integer",
            "default": 45,
            "examples": [
                45
            ]
        },
        "samples_per_pixel": {
            "type": "integer",
            "default": 0,
            "title": "The samples_per_pixel Schema",
            "examples": [
                224
            ]
        },
        "up_axis": {
            "type": "array",
            "default": [
                [0, 0, 1]
            ],
            "items": {
                "type": "integer"
            },
            "examples": [
                [0, 0, 1],
                [0, 1, 0],
                [1, 0, 0]
            ]
        },
        "rotation_axis": {
            "type": "array",
            "default": [0, 0, 1],
            "items": {
                "type": "integer"
            },
            "examples": [
                [0, 0, 1],
                [0, 1, 0],
                [1, 0, 0]
            ]
        },
        "add_floor": {
            "type": "boolean",
            "default": true
        },
        "floor_type": {
            "type": "string",
            "default": "diffuse",
            "title": "The floor_type Schema",
            "examples": [
                "diffuse",
                "checkerboard"
            ]
        },
        "floor_color": {
            "type": "array",
            "default": [
                [0.1, 0.25, 0.3]
            ],
            "items": {
                "type": "number"
            },
            "examples": [
                [0.1, 0.25, 0.3],
                [0.5, 0.35, 0.13]
            ]
        },
        "add_background": {
            "type": "boolean",
            "default": false
        }
    }
}
```

The fields of type number or integer can take any positive value (or string "auto" in some cases). The fields of type string only support the values provided in `examples` array. 

### "objects" field: Object settings

```
"objects": {
    "type": "array",
    "items": {
        "type": "object",
        "required": [
            "name",
            "filename",
            "type",
            "material"
        ],
        "properties": {
            "name": {
                "type": "string",
                "examples": [
                    "My metal object"
                ]
            },
            "filename": {
                "type": "string",
                "examples": [
                    "path/to/myobject.obj"
                ]
            },
            "type": {
                "type": "string",
                "examples": [
                    "obj",
                    "ply",
                    "linearcurve"
                ]
            },
            "material": {
                "type": "object",
                "properties": {
                    "type": {
                        "type": "string",
                        "default": "diffuse",
                        "examples": [
                            "metal",
                            "plastic",
                            "roughmetal",
                            "roughplastic",
                            "glass",
                            "thinglass",
                            "roughglass",
                            "diffuse",
                            "conductor",
                            "roughconductor",
                            "dielectric",
                            "thindielectric",
                            "roughdielectric",
                        ]
                    },
                    "color": {
                        "type": "array",
                        "default": [
                            [0.1, 0.27, 0.36]
                        ],
                        "items": {
                            "type": "number"
                        },
                        "examples": [
                            [0.1, 0.27, 0.36]
                        ]
                    },
                    "metal_type": {
                        "type": "string",
                        "default": "Au",
                        "examples": [
                            "Au",
                            "Al"
                        ]
                    },
                    "alpha": {
                        "type": "number",
                        "default": 0.1,
                        "examples": [
                            1
                        ]
                    }
                }
            }
        }
    }
}
```
Again, the fields of type number or integer can take any positive value. The fields of type string only support the values provided in `examples` array, except `name` field that can take any string and `metal_type` field that some additional values than the ones is `examples` can be supported.

The `metal_type` field can take any of the following values:

![image](https://github.com/andriani-st/mitsuba3-util/assets/77795248/4a2e064d-65b6-4209-98dc-9171c122f80b)

> source: https://mitsuba.readthedocs.io/en/stable/src/generated/plugins_bsdfs.html


### "lights" field: Light settings

```
"lights": {
    "type": "array",
    "items": {
        "type": "object",
        "required": [
            "emitter_type",
            "filename",
            "name"
        ],
        "properties": {
            "name": {
                "type": "string",
                "examples": [
                    "light1"
                ]
            },
            "emitter_type": {
                "type": "string",
                "examples": [
                    "area",
                    "envmap"
                ]
            },
            "emitter_shape": {
                "type": "string",
                "default": "sphere",
                "examples": [
                    "sphere",
                    "rectangle"
                ]
            },
            "filename": {
                "type": "string",
                "examples": [
                    "path/to/envmap/if/type/envmap"
                ]
            },
            "rotation_axis": {
                "type": "array",
                "default": [
                    [1, 0, 0]
                ],
                "items": {
                    "type": "integer"
                },
                "examples": [
                    [1, 0, 0],
                    [0, 1, 0],
                    [0, 0, 1]
                ]
            },
            "rotation_degrees": {
                "type": "integer",
                "default": 90
            },
            "scale_factor": {
                "type": "number",
                "default": 0.5
            },
            "radiance": {
                "type": "integer",
                "default": 10
            },
            "size": {
                "type": "string",
                "default": "medium",
                "examples": [
                    "medium",
                    "small",
                    "large"
                ]
            },
            "distance_from_object": {
                "type": "string",
                "default": "medium",
                "examples": [
                    "medium",
                    "small",
                    "large"
                ]
            },
            "position": {
                "type": "string",
                "default": "top-center",
                "examples": [
                    "top-center",
                    "top-right",
                    "top-left",
                    "bottom-left",
                    "bottom-right",
                    "top-center-front",
                    "top-left-front",
                    "top-right-front",
                    "bottom-center-front",
                    "bottom-left-front",
                    "bottom-right-front",
                    "top-center-back",
                    "top-left-back",
                    "top-right-back",
                    "bottom-center-back",
                    "bottom-left-back",
                    "bottom-right-back"
                ]
            }
        }
    }
}
```

## Stained glass

For rendering stained_glass in a room:
```
cd stained_glass
python3 stained_glass_room.py /path/to/json/file/config.json
```
For stained_glass_room.py to run a configuration file of the following structure is required:
```
{
    "output": {
      "type": "image",
      "fov": 45,
      "width": 512,
      "height": 512,
      "samples_per_pixel": 20000000
    },
    "files": {
        "tiles_path": "example_files/1/tiles/",
        "skeleton_path": "example_files/1/skeleton.obj",
        "colors_path": "example_files/1/colors.txt"
    }
}
```

> In folder mitsuba3-util/stained_glass/config_files examples of configuration files can be found and in mitsuba3-util/stained_glass/example_files examples of obj files produced by the MATLAB script can be found.

By modifying the config.json that passes as an argument above, the following outputs are available:
- Rendered png images of specified size and quality
- Rotation videos of specified number of views (e.g. full rotations with 360 views)
- Animation videos by rendering OBJ frames
- Rotation videos of animations of specified number of views

In more detail:

## Creating an image of specified size and quality
A basic configuration file for rendering an object from an OBJ file will look like:
```
{
  "output": {
    "type": "image",
    "spp": 1024,
    "width": 512
    "height": 512
},
"camera": {
  "fov": 45,
},
"objects": [
  {
      "name": "glass",
      "filename": "glass.obj",
      "material": {
         "type": "glass"
      }
  }
],
"lights": [
  {
      "name": "light1",
      "emitter_type": "area",
      "emitter_shape": "rectangle",
      "position": "back"
      "radiance": 10
  }
]
}

```

The above script uses some options provided by the util for the material and the position of the light but the user can also set these values as described in Mitsuba's documentation. The above script created the following rendered image for an object described in glass.obj file:

![image](https://github.com/andriani-st/mitsuba3-util/assets/77795248/5892eada-94a0-4a5f-a945-ed73832e93d7)


## Creating a rotation video
A basic configuration file for creating a rotation video of an OBJ file will look like:

```
{
  "output": {
    "type": "rotation_video",
    "rotation_axis": [0,0,1],
    "rotation_degrees": 360,
    "rotation_step":10,
    "fov": 45,
    "up_axis": [0,0,1],
    "width": 512,
    "height": 512,
    "samples_per_pixel": 224,
    "add_floor": true,
    "add_background": false,
    "results_folder": ""
  },
  "objects": [
    {
      "name": "glass_cylinder",
      "filename": "obj_files/cylinder.obj",
      "type":"obj",
      "material": {
        "type": "glass",
        "color": [0.871, 0.804, 0.961]
      }
    }
  ],
  "lights": [
    {
      "name": "light1",
      "emitter_type": "envmap",
      "filename":"envmaps/christmas_photo_studio_4k_resized.hdr"
    }
  ]
}
```

The above configuration file creates a .avi rotation video. Some selected frames of that video:
![image](https://github.com/andriani-st/mitsuba3-util/assets/77795248/a752db2d-b235-4b82-bbf1-ca4382d27a80)

## Creating an animation video
A basic configuration file for creating an animation video from OBJ frames:
```
{
  "output": {
    "type": "animation_video",
    "rotation_axis": [0,1,0],
    "rotation_degrees": 360,
    "rotation_step":10,
    "fov": 45,
    "up_axis": [0,1,0],
    "width": 512,
    "height": 512,
    "samples_per_pixel": 1024,
    "add_floor": true,
    "add_background": false,
    "results_folder": ""
  },
  "objects": [
    {
      "name": "material",
      "filename": "animation_files/01_cutting/3d_out/material/",
      "type":"obj",
      "material": {
        "type": "metal"
      }
    },
    {
      "name": "tool",
      "filename": "animation_files/01_cutting/3d_out/tool/",
      "type":"obj",
      "material": {
        "type": "roughglass"
      }
    },
    {
      "name": "scene",
      "filename": "animation_files/01_cutting/3d_out/scene/floor.obj",
      "type":"obj",
      "material": {
        "type": "plastic"
      }
    }
  ],
  "lights": [
    {
      "name": "light1",
      "emitter_type": "area",
      "emitter_shape": "sphere",
      "position": "top-center",
      "radiance": 100,
      "distance_from_object": "large",
      "size": "small"
    },
    {
      "name": "light2",
      "emitter_type": "area",
      "emitter_shape": "sphere",
      "position": "top-right",
      "radiance": 100,
      "distance_from_object": "large",
      "size": "large"
    },
    {
      "name": "light3",
      "emitter_type": "area",
      "emitter_shape": "sphere",
      "position": "top-left",
      "radiance": 100,
      "distance_from_object": "large",
      "size": "large"
    }
  ]
}

```

The above configuration file creates a .avi animation video. Some selected frames of that video:
![image](https://github.com/andriani-st/mitsuba3-util/assets/77795248/6c30b1b4-8828-48f2-ac09-9f3266667ec9)
